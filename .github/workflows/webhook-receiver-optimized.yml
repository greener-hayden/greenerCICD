name: GitHub App Webhook Receiver (Optimized)

on:
  repository_dispatch:
    types: [app_webhook]

permissions:
  actions: write

jobs:
  handle-webhook:
    runs-on: ubuntu-22.04
    timeout-minutes: 1  # Reduced from 2 minutes
    if: github.repository == 'greener-hayden/greenerCICD'

    steps:
      # No checkout needed - everything inline
      - name: Process webhook
        env:
          EVENT: ${{ github.event.client_payload.event }}
          PAYLOAD: ${{ github.event.client_payload.payload }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ultra-fast webhook processing
          echo "ðŸ“¨ $EVENT webhook"

          # Only process installation events
          if [[ "$EVENT" != *"installation"* ]]; then
            echo "â­ï¸ Skipping non-installation event"
            exit 0
          fi

          # Decode and check for repos
          REPOS=$(echo "$PAYLOAD" | base64 -d | \
            grep -o '"full_name":"[^"]*"' | \
            cut -d'"' -f4 | head -20)  # Limit to prevent abuse

          if [ -n "$REPOS" ]; then
            echo "ðŸ”„ Triggering sync for $(echo "$REPOS" | wc -l) repos"

            # Direct API call (faster than gh CLI)
            curl -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-app-secrets-optimized.yml/dispatches \
              -d '{"ref":"main"}' \
              --fail-with-body || echo "âš ï¸ Sync trigger failed"
          else
            echo "â„¹ï¸ No repos to process"
          fi

      - name: Log summary
        if: always()
        run: |
          echo "### Webhook Processed" >> $GITHUB_STEP_SUMMARY
          echo "- Event: \`${{ github.event.client_payload.event }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY