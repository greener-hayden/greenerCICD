<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greener CI/CD Webhook Proxy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f6f8fa;
        }
        .container {
            background: white;
            border-radius: 6px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        h1 {
            color: #24292e;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success { background: #f0f9ff; border: 1px solid #0969da; }
        .error { background: #fff5f5; border: 1px solid #d1242f; }
        .info { background: #f6f8fa; border: 1px solid #d0d7de; }
        code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 85%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Greener CI/CD Webhook Proxy</h1>

        <div class="status info">
            <p><strong>Status:</strong> Webhook proxy is active</p>
            <p>This page receives GitHub webhooks and forwards them to GitHub Actions for processing.</p>
        </div>

        <div id="result"></div>

        <h2>Configuration</h2>
        <p>To use this webhook proxy:</p>
        <ol>
            <li>Set your GitHub App webhook URL to: <code id="webhook-url"></code></li>
            <li>Ensure the following secrets are set in your repository:
                <ul>
                    <li><code>GREENER_APP_ID</code></li>
                    <li><code>GREENER_APP_PRIVATE_KEY</code></li>
                    <li><code>GREENER_WEBHOOK_SECRET</code></li>
                    <li><code>WEBHOOK_PROXY_TOKEN</code> (for API authentication)</li>
                </ul>
            </li>
        </ol>

        <h2>How It Works</h2>
        <p>When GitHub sends a webhook to this page:</p>
        <ol>
            <li>The webhook payload is received via POST request</li>
            <li>The payload is base64 encoded for safe transmission</li>
            <li>A workflow_dispatch event is triggered via GitHub API</li>
            <li>GitHub Actions processes the webhook in a secure environment</li>
            <li>Secrets are automatically provisioned to target repositories</li>
        </ol>

        <p><small>Last updated: <span id="timestamp"></span></small></p>
    </div>

    <script>
        // Display current URL
        document.getElementById('webhook-url').textContent = window.location.href.replace(/\.html$/, '');
        document.getElementById('timestamp').textContent = new Date().toLocaleString();

        // Configuration - will be replaced during deployment
        const CONFIG = {
            owner: 'greener-hayden',
            repo: 'dotfiles',
            workflow: 'webhook-handler.yml',
            token: null  // Will be set via GitHub Pages secret or environment
        };

        // Handle incoming webhooks (via Cloudflare Workers or similar edge function)
        async function handleWebhook(request) {
            try {
                // Get webhook data
                const event = request.headers.get('X-GitHub-Event');
                const signature = request.headers.get('X-Hub-Signature-256');
                const delivery = request.headers.get('X-GitHub-Delivery');
                const payload = await request.text();

                // Encode payload for safe transmission
                const encodedPayload = btoa(payload);

                // Trigger GitHub Actions workflow
                const response = await fetch(
                    `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/actions/workflows/${CONFIG.workflow}/dispatches`,
                    {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${CONFIG.token}`,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Greener-CI-CD-Webhook-Proxy'
                        },
                        body: JSON.stringify({
                            ref: 'main',
                            inputs: {
                                event: event,
                                payload: encodedPayload,
                                signature: signature || ''
                            }
                        })
                    }
                );

                if (response.ok) {
                    return new Response(JSON.stringify({
                        success: true,
                        delivery: delivery,
                        message: 'Webhook forwarded to GitHub Actions'
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                } else {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
            } catch (error) {
                console.error('Webhook proxy error:', error);
                return new Response(JSON.stringify({
                    success: false,
                    error: error.message
                }), {
                    status: 500,
                    headers: { 'Content-Type': 'application/json' }
                });
            }
        }

        // For GitHub Pages, we need an edge worker (Cloudflare Workers, Vercel Edge, etc.)
        // This is just the client-side display page
        if (typeof window !== 'undefined') {
            // Check if we're receiving a webhook response
            const params = new URLSearchParams(window.location.search);
            if (params.get('status')) {
                const resultDiv = document.getElementById('result');
                if (params.get('status') === 'success') {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>âœ“ Success:</strong> Webhook processed successfully
                            <br>Delivery ID: ${params.get('delivery') || 'N/A'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>âœ— Error:</strong> ${params.get('error') || 'Unknown error'}
                        </div>
                    `;
                }
            }
        }
    </script>
</body>
</html>