<!DOCTYPE html>
<html>
<head>
  <title>Greener CI/CD Webhook</title>
  <meta charset="utf-8">
  <script>
    // Simple webhook receiver that triggers GitHub Action
    async function handleWebhook(request) {
      const event = request.headers.get('X-GitHub-Event');
      const signature = request.headers.get('X-Hub-Signature-256');
      const payload = await request.text();

      // Only handle installation events
      if (!event?.includes('installation')) {
        return new Response('Event ignored', { status: 200 });
      }

      // Trigger repository_dispatch event
      const response = await fetch(
        'https://api.github.com/repos/greener-hayden/dotfiles/dispatches',
        {
          method: 'POST',
          headers: {
            'Authorization': 'token ' + GITHUB_TOKEN,  // Set via Cloudflare/Vercel env
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            event_type: 'app_webhook',
            client_payload: {
              event: event,
              payload: btoa(payload),
              signature: signature
            }
          })
        }
      );

      return new Response(
        response.ok ? 'Webhook processed' : 'Failed',
        { status: response.ok ? 200 : 500 }
      );
    }

    // For GitHub Pages, we need an edge function
    if (typeof addEventListener !== 'undefined') {
      addEventListener('fetch', event => {
        event.respondWith(handleWebhook(event.request));
      });
    }
  </script>
</head>
<body>
  <h1>Greener CI/CD Webhook Endpoint</h1>
  <p>This endpoint receives GitHub App webhooks.</p>
  <p>Status: Active âœ…</p>
</body>
</html>